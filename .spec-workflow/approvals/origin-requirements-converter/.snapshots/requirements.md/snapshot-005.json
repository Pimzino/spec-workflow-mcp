{
  "id": "snapshot_1760596043563_b80i9mh5e",
  "approvalId": "approval_1760595901399_bo8jtl4io",
  "approvalTitle": "需求文档审批（修订版4）- 原始需求文档转换器",
  "version": 5,
  "timestamp": "2025-10-16T06:27:23.563Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# 需求文档 - 原始需求文档转换器\n\n## 介绍\n\n本功能旨在为 spec-workflow-mcp 项目添加原始需求文档自动转换能力。用户可以将各种格式的原始需求文档（如 Word、PDF 等）存放在专门的目录中，系统能够自动识别、转换并生成符合 spec-workflow 规范的 Markdown 格式需求文档。\n\n该功能通过引入新的 MCP tool 和文件转换服务，支持以 `#` 符号引用原始需求文件（如 `#test.docx`），自动完成格式转换和规范化处理，大幅降低用户手动整理需求文档的工作量。\n\n**核心价值：**\n\n- 支持多种原始需求文档格式\n- 自动转换为 Markdown 格式\n- 生成符合 spec-workflow 规范的需求文档\n- 提供灵活的转换工具配置（本地工具或 API）\n- 保留转换历史和临时文件便于调试\n\n## 与产品愿景的一致性\n\n此功能支持以下产品目标：\n\n- **降低使用门槛**：用户无需手动将 Word 等格式转换为 Markdown\n- **提升工作效率**：自动化完成格式转换和规范化处理\n- **增强可扩展性**：设计支持多种文档格式的转换扩展\n- **改善用户体验**：通过简单的 `#filename` 引用方式简化操作\n\n## 需求\n\n### 需求 1：原始需求文档存储目录与文件组织\n\n**用户故事：** 作为一个项目管理者，我想要有一个专门的目录存放各种格式的原始需求文档，以便统一管理和引用这些文档。\n\n#### 验收标准\n\n1. 当用户在项目根目录创建 `origin-requirements/` 文件夹时，系统应该识别并支持该目录作为原始需求文档存储位置\n2. 当用户在 `origin-requirements/` 目录下放置文档文件（`.docx`, `.pdf`, `.md` 等）时，系统应该能够扫描和识别这些文件\n3. 当系统进行文档转换时，应该在 `origin-requirements/.temp/{filename}/` 目录下存储转换结果，其中 `{filename}` 是不含扩展名的原始文件名\n4. 当 Pandoc 转换生成多个文件时（如 `.md` 文件和 `media/` 文件夹），应该都存放在同一个 `.temp/{filename}/` 目录下\n5. 例如：转换 `test.docx` 时，应该创建 `.temp/test/` 目录，包含 `test.md` 和 `media/` 文件夹\n6. 当转换完成后，系统应该保留 `.temp/` 目录中的文件以便用户查看和调试\n\n### 需求 2：文档引用语法支持\n\n**用户故事：** 作为一个用户，我想要通过简单的 `#filename` 语法引用原始需求文档，以便快速触发文档转换和处理流程。\n\n#### 验收标准\n\n1. 当用户输入以 `#` 开头的命令（如 `#test.docx`）时，系统应该识别为原始需求文档引用\n2. 当系统检测到 `#filename` 格式时，应该自动在 `origin-requirements/` 目录下查找对应文件\n3. 如果找到文件，系统应该根据文件扩展名确定处理策略（直接读取 MD 或转换其他格式）\n4. 如果未找到文件，系统应该返回友好的错误提示，指明文件不存在或路径错误\n\n### 需求 3：Markdown 文件直接处理\n\n**用户故事：** 作为一个用户，我想要当原始需求文档已经是 Markdown 格式时，系统能够直接读取并生成符合 spec-workflow 规范的需求文档，以便节省转换时间。\n\n#### 验收标准\n\n1. 当用户引用的文件是 `.md` 格式时，系统应该跳过格式转换步骤\n2. 当系统读取 Markdown 文件时，应该直接解析文件内容\n3. 当解析完成后，系统应该将内容转换为符合 spec-workflow 规范的 `requirements.md` 格式\n4. 当生成的需求文档应该保持原始 Markdown 中的关键信息（标题、列表、表格等）\n\n### 需求 4：Word 文档 Pandoc 转换支持（本次实现）\n\n**用户故事：** 作为一个用户，我想要系统能够使用 Pandoc 自动将 Word 格式的需求文档转换为 Markdown，以便我可以继续使用熟悉的 Word 编辑原始需求。\n\n#### 验收标准\n\n1. 当用户引用的文件是 `.docx` 或 `.doc` 格式时，系统应该触发 Word 转 Markdown 转换流程（**本次只实现 word2md 转换类型**）\n2. 当本地 Pandoc 可用时（通过命令行参数 `--pandocPath` 或配置文件中的 `pandocPath` 参数指定，或系统 PATH），应该优先使用 Pandoc 本地工具进行转换\n3. 当使用本地 Pandoc 转换时，应该先创建输出目录 `.temp/{filename}/`，然后执行命令：`pandoc input.docx -f docx -t gfm --extract-media=./origin-requirements/.temp/{filename}/media --wrap=none -o .temp/{filename}/{filename}.md`\n4. 当转换命令执行时，所有输出文件（Markdown 和媒体资源）应该组织在 `.temp/{filename}/` 目录下，如有同名目录直接覆盖\n5. 当本地 Pandoc 不可用时，系统应该自动降级到 API 接口进行转换\n6. 当使用 API 转换时，应该将原始需求文件作为参数发送到 API 服务（API 服务也是基于 Pandoc 实现的）\n7. 当 API 请求成功时，应该接收返回的**压缩包**（包含 .md 文件和 media 文件夹），解压到 `.temp/{filename}/` 目录\n8. 当压缩包解压后，应该验证目录结构：`.temp/{filename}/{filename}.md` 和可选的 `.temp/{filename}/media/`\n9. 当转换成功后，系统应该读取 `.temp/{filename}/{filename}.md` 文件继续处理\n\n### 需求 5：Pandoc 转换工具配置\n\n**用户故事：** 作为一个用户，我想要能够通过命令行参数或配置文件配置 Pandoc 可执行文件路径，以便使用本地安装的 Pandoc 工具进行文档转换，如果本地没有安装则自动降级到 API 服务。\n\n#### 验收标准\n\n1. 当用户通过命令行参数 `--pandocPath` 指定 Pandoc 路径时，系统应该优先使用该路径的 Pandoc 可执行文件\n2. 当未指定 `--pandocPath` 参数时，系统应该从配置文件（`.spec-workflow/config.toml`）读取 `pandocPath` 配置项\n3. 当命令行参数和配置文件都未设置时，系统应该尝试直接使用 `pandoc` 命令（假设 Pandoc 已在系统 PATH 中）\n4. 当执行 `pandoc --version` 命令成功时，系统应该判定本地 Pandoc 可用并使用本地转换\n5. 当本地 Pandoc 不可用（命令执行失败）时，系统应该自动降级到 API 服务进行转换\n6. 当使用 API 服务时，系统应该从配置文件（`.spec-workflow/config.toml`）读取 `converterApiUrl` 配置项\n7. 当 API 服务也是基于 Pandoc 实现的，应该确保转换质量和格式一致性\n8. 当配置文件示例（`config.example.toml`）应该包含 `pandocPath` 和 `converterApiUrl` 的配置说明和示例\n9. **配置优先级**：命令行参数 `--pandocPath` > 配置文件 `pandocPath` > 系统 PATH 中的 `pandoc` > API 服务\n\n### 需求 6：新 MCP Tool - convert-origin-requirement\n\n**用户故事：** 作为一个 AI 助手用户，我想要有一个专门的 MCP tool 来处理原始需求文档转换，以便在对话中方便地触发转换和生成流程。\n\n#### 验收标准\n\n1. 当系统注册 MCP tool 时，应该包含名为 `convert-origin-requirement` 的新工具\n2. 当调用该工具时，应该接受 `filename` 参数（如 `test.docx`）\n3. 当工具执行时，应该完成以下步骤：\n   - 在 `origin-requirements/` 目录查找文件\n   - 判断文件格式并选择处理策略\n   - 必要时调用转换服务\n   - 读取或生成的 Markdown 内容\n   - 转换为 spec-workflow 规范的需求文档\n   - 将结果保存到 `.spec-workflow/specs/{spec-name}/requirements.md`\n4. 当工具执行成功时，应该返回生成的需求文档路径和摘要信息\n5. 当工具执行失败时，应该返回详细的错误信息和建议的解决方案\n\n### 需求 7：文件转换服务模块（策略模式）\n\n**用户故事：** 作为一个开发者，我想要有一个基于策略模式的文件转换服务模块，以便在项目中复用转换逻辑并便于扩展其他格式支持。\n\n#### 验收标准\n\n1. 当创建转换服务时，应该定义 `DocumentConverter` 类，使用**策略模式**设计支持多种转换类型\n2. 当定义转换策略时，应该创建 `IConversionStrategy` 接口，包含 `convert()` 方法\n3. 当实现具体策略时，应该创建 `Word2MdStrategy` 类（**本次实现**），实现 word2md 转换逻辑\n4. 当实现具体策略时，应该创建 `Md2WordStrategy` 类（**本次实现**），实现 md2word 转换逻辑\n5. 当定义其他转换类型时，应该预留 `Excel2MdStrategy`（xlsx2md）、`Pdf2MdStrategy` 等策略类定义，但**本次不实现**\n6. 当转换服务初始化时，应该加载命令行参数 `--pandocPath` 或配置文件中的 `pandocPath` 和 `converterApiUrl`\n7. 当调用 `convert()` 方法时，应该根据转换类型选择对应的策略执行转换\n8. 当使用 Pandoc 本地工具时，`Word2MdStrategy` 应该：\n   - 创建输出目录：`.temp/{filename}/`\n   - 构建命令：`pandoc -f docx -t gfm --extract-media=.temp/{filename}/media --wrap=none -o .temp/{filename}/{filename}.md {input}`\n   - 验证输出文件和媒体目录是否生成\n9. 当使用 Pandoc 本地工具时，`Md2WordStrategy` 应该：\n   - 构建命令：`pandoc -f gfm -t docx -o {output_dir}/{filename}.docx {input}`\n   - 生成的 Word 文件应该放在输入文件的同级目录\n   - 验证输出文件是否生成\n10. 当使用 API 接口时，应该：\n    - 发送原始需求文件到 API 服务\n    - 接收返回的**压缩包**（zip 格式，word2md）或文件流（md2word）\n    - word2md：解压到 `.temp/{filename}/` 目录\n    - md2word：保存到输入文件同级目录\n    - 验证输出文件结构\n11. 当目录已存在时（word2md），应该先删除旧目录再创建新目录（确保干净的转换环境）\n\n### 需求 8：错误处理和用户反馈\n\n**用户故事：** 作为一个用户，我想要在转换过程中遇到问题时能够得到清晰的错误提示，以便快速定位和解决问题。\n\n#### 验收标准\n\n1. 当原始文件不存在时，系统应该提示：\"未找到文件 '{filename}'，请检查文件路径\"\n2. 当文件格式不支持时，系统应该提示：\"不支持的文件格式 '{extension}'，当前支持: .md, .docx, .doc\"\n3. 当命令行参数 `--pandocPath` 或配置文件 `pandocPath` 指向的路径无效时，系统应该提示：\"pandocPath 配置的路径无效: {path}，将尝试使用系统 PATH 中的 pandoc\"\n4. 当本地 Pandoc 不可用时，系统应该提示：\"本地 Pandoc 不可用，正在降级到 API 服务...\"\n5. 当 Pandoc 命令执行失败时，应该捕获错误输出并显示：\"Pandoc 转换失败: {error_message}\"\n6. 当 API 接口调用失败时，系统应该提示：\"API 转换服务不可用（HTTP {status_code}），请检查网络连接或配置 pandocPath 参数\"\n7. 当 API 返回的压缩包为空或格式错误时，系统应该提示：\"API 返回的转换结果无效，请检查 API 服务或原始文档内容\"\n8. 当解压缩失败时，系统应该提示：\"解压转换结果失败: {error_message}\"\n9. 当转换后的文件不存在时，系统应该提示文件未找到和预期路径\n10. 当所有错误信息应该同时记录到日志文件中，包含详细的执行上下文和堆栈信息\n\n### 需求 9：文档转换质量优化\n\n**用户故事：** 作为一个用户，我想要转换后的 Markdown 文档能够保留原始文档的关键信息和格式，以便生成高质量的需求文档。\n\n#### 验收标准\n\n1. 当转换 Word 文档时，应该保留标题层级结构（H1-H6）\n2. 当转换包含表格的文档时，应该转换为 Markdown 表格格式\n3. 当转换包含图片的文档时，应该提取图片到 `.temp/media/` 目录并生成正确的引用链接\n4. 当转换包含列表的文档时，应该保留有序列表和无序列表的格式\n5. 当转换包含代码块的文档时，应该使用 Markdown 代码块语法\n6. 当转换完成后，系统应该进行基本的 Markdown 语法校验\n\n### 需求 10：新 MCP Tool - md2word（Markdown 转 Word）\n\n**用户故事：** 作为一个用户，我想要有一个工具能够将 Markdown 文件高还原转换为 Word 格式，以便分享给使用 Word 的同事或客户。\n\n#### 验收标准\n\n1. 当系统注册 MCP tool 时，应该包含名为 `md2word` 的新工具\n2. 当调用该工具时，应该接受 `filePath` 参数，指定要转换的 Markdown 文件完整路径\n3. 当工具执行时，应该使用 Pandoc 进行转换，命令格式：`pandoc -f gfm -t docx -o {output} {input}`\n4. 当转换成功时，生成的 Word 文件应该保存在输入文件的同级目录，文件名与输入文件同名但扩展名改为 `.docx`\n5. 例如：输入 `/path/to/document.md`，输出应为 `/path/to/document.docx`\n6. 当输出文件已存在时，应该直接覆盖\n7. 当转换时，应该尽可能保留 Markdown 的格式：\n   - 标题层级（H1-H6）\n   - 列表（有序和无序）\n   - 表格\n   - 代码块\n   - 粗体、斜体、链接等\n   - 图片引用（如果路径有效）\n8. 当转换成功后，工具应该返回生成的 Word 文件路径\n9. 当转换失败时，应该返回详细的错误信息\n10. 当使用本地 Pandoc 不可用时，应该自动降级到 API 服务进行转换\n\n### 需求 11：转换临时文件管理\n\n**用户故事：** 作为一个用户，我想要查看转换后的临时文件，以便验证转换结果或调试转换问题。\n\n#### 验收标准\n\n1. 当文件转换成功时，系统应该在 `origin-requirements/.temp/{filename}/` 目录保留所有转换结果\n2. 当转换 `test.docx` 时，目录结构应该是：\n   ```\n   origin-requirements/.temp/test/\n   ├── test.md           # 转换后的 Markdown 文件\n   └── media/            # 提取的图片和资源（如有）\n       ├── image1.png\n       └── image2.png\n   ```\n3. 当同一文件多次转换时，系统应该先删除旧的 `.temp/{filename}/` 目录，再创建新目录（确保干净状态）\n4. 当 Pandoc 本地转换时，媒体文件应该直接提取到 `.temp/{filename}/media/` 目录\n5. 当 API 服务返回压缩包时，应该解压到 `.temp/{filename}/` 目录，保持相同的文件组织结构\n6. 当用户可以在 `.temp/{filename}/` 目录中查看完整的转换结果，包括 Markdown 文件和所有媒体资源\n7. 当系统应该在 `.gitignore` 中添加 `origin-requirements/.temp/` 规则，不提交到 Git 仓库\n8. 当系统可选提供清理临时文件的功能（本次不强制实现）\n\n## 非功能性需求\n\n### 代码架构和模块化\n\n- **单一职责原则**:\n  - `DocumentConverter` 类专注文档格式转换\n  - MCP tool 专注处理用户输入和流程编排\n  - 需求文档生成逻辑独立为单独模块\n- **模块化设计**:\n  - 转换服务应该是独立模块，可在其他场景复用\n  - 支持插件式扩展不同格式的转换器\n  - 配置管理独立，支持多种配置源（文件、命令行、环境变量）\n- **依赖管理**:\n  - 转换服务不应依赖 MCP 相关代码\n  - 使用依赖注入传入配置和依赖项\n  - 避免循环依赖\n- **清晰的接口**:\n  - 定义 `IConverter` 接口规范转换器行为\n  - 定义 `ConversionResult` 类型表示转换结果\n  - 统一错误类型和错误处理\n\n### 性能\n\n- 单个文档转换时间应在 5 秒内完成（本地工具）\n- API 转换超时设置为 30 秒\n- 支持并发转换多个文档（当批量处理时）\n- 临时文件缓存命中时应秒级响应\n\n### 安全性\n\n- 文件路径必须校验，防止路径遍历攻击\n- 上传到 API 的文件大小限制为 10MB\n- API 接口调用必须使用 HTTPS\n- 不在日志中记录文件完整内容\n\n### 可靠性\n\n- 转换失败时必须有本地工具到 API 的自动降级\n- 网络请求必须有重试机制（最多 3 次）\n- 临时文件损坏时应重新执行转换\n- 提供详细的错误日志便于问题诊断\n\n### 可用性\n\n- 提供详细的配置文档和示例\n- 错误提示应包含可操作的建议\n- 支持 `--verbose` 参数输出详细转换过程\n- Dashboard 中显示转换进度和状态\n\n### 可维护性\n\n- 代码注释清晰，特别是转换逻辑部分\n- 提供单元测试覆盖核心转换逻辑\n- 提供集成测试验证端到端流程\n- 文档包含架构图和流程图\n\n### 可扩展性\n\n- **策略模式设计**：支持未来添加 Excel（xlsx2md）、PDF、HTML 等转换类型\n- **本次实现范围**：实现 `Word2MdStrategy`（word2md）和 `Md2WordStrategy`（md2word）\n- **预留扩展接口**：定义但不实现 `Excel2MdStrategy`、`Pdf2MdStrategy` 等策略类\n- 转换器架构支持插拔式添加新的转换策略\n- 配置参数支持其他转换工具路径扩展（如命令行参数 `--excelConverterPath`）\n\n## 技术约束\n\n- 使用 TypeScript 实现，遵循项目现有代码风格\n- 兼容 Node.js 20.x+\n- 使用项目现有的配置管理机制（toml）\n- MCP tool 遵循 MCP SDK 规范\n- 文件操作使用 Node.js fs/promises API\n- HTTP 请求使用 fetch API（Node.js 18+内置）\n- **必须使用 Pandoc** 作为核心转换工具（本地或 API）\n- **本次实现 word2md 和 md2word 两种转换类型**\n\n## 依赖和集成\n\n- **核心依赖**：Pandoc（通过命令行参数 `--pandocPath` 或配置文件 `pandocPath` 配置，或系统 PATH）\n- **降级方案**：基于 Pandoc 的文档转换 API 服务（word2md 返回 zip 压缩包，md2word 返回文件流）\n- **Docker 支持**：Dockerfile 中应包含 Pandoc 安装，确保容器化部署时可直接使用\n- 集成到现有的 spec-workflow 流程中\n- 与 Dashboard 集成显示转换状态\n- 与审批流程集成\n\n## Docker 部署要求\n\n### Dockerfile 配置\n\n当项目使用 Docker 部署时，应该在 Dockerfile 中安装 Pandoc：\n\n```dockerfile\n# 安装 Pandoc\nRUN apt-get update && \\\n    apt-get install -y pandoc && \\\n    apt-get clean && \\\n    rm -rf /var/lib/apt/lists/*\n\n# 验证 Pandoc 安装\nRUN pandoc --version\n```\n\n### 验收标准\n\n1. 当使用 Docker 构建镜像时，应该自动安装 Pandoc\n2. 当容器启动后，应该可以直接使用 `pandoc` 命令，无需配置 `--pandocPath` 参数\n3. 当 Pandoc 安装失败时，Docker 构建应该失败并提示错误\n4. 当应该在 Docker 文档中说明 Pandoc 的安装和验证步骤\n\n## 配置参数说明\n\n### 命令行参数\n\n#### --pandocPath\n\n- **用途**：指定 Pandoc 可执行文件的完整路径\n- **示例**：\n  - macOS/Linux: `node dist/index.js --pandocPath=/usr/local/bin/pandoc`\n  - Windows: `node dist/index.js --pandocPath=\"C:\\Program Files\\Pandoc\\pandoc.exe\"`\n- **优先级**：最高（优先于配置文件和系统 PATH）\n\n### 配置文件参数\n\n在 `.spec-workflow/config.toml` 中配置：\n\n```toml\n# Pandoc 可执行文件路径（可选）\npandocPath = \"/usr/local/bin/pandoc\"\n\n# 文档转换 API 服务地址（降级方案）\nconverterApiUrl = \"https://converter-api.example.com/convert\"\n```\n\n#### pandocPath\n\n- **用途**：指定 Pandoc 可执行文件的完整路径\n- **优先级**：中等（低于命令行参数，高于系统 PATH）\n- **示例**：\n  - macOS/Linux: `pandocPath = \"/usr/local/bin/pandoc\"`\n  - Windows: `pandocPath = \"C:\\\\Program Files\\\\Pandoc\\\\pandoc.exe\"`\n\n#### converterApiUrl\n\n- **用途**：指定文档转换 API 服务地址（当本地 Pandoc 不可用时使用）\n- **示例**：`converterApiUrl = \"https://converter-api.example.com/convert\"`\n\n### 配置优先级总结\n\n1. **命令行参数** `--pandocPath`（最高优先级）\n2. **配置文件** `pandocPath`\n3. **系统 PATH** 中的 `pandoc` 命令\n4. **API 服务** `converterApiUrl`（降级方案）\n",
  "fileStats": {
    "size": 19584,
    "lines": 368,
    "lastModified": "2025-10-16T06:25:29.065Z"
  },
  "comments": []
}